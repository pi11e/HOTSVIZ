-- Increase the group_concat_max_len limit to handle larger concatenated strings
SET SESSION group_concat_max_len = 1000000;

-- Fetch the distinct dates from game_timestamp for ranked games
SET @dates = (
    SELECT GROUP_CONCAT(DISTINCT CONCAT('\'', DATE(game_timestamp), '\''))
    FROM uniqueGames
    WHERE game_mode = 'stormLeague'
    ORDER BY game_timestamp
);

-- Construct the full query to calculate aggregated winrate and games played over time
SET @sql = CONCAT(
    'SELECT 
        game_date,
        winrate_each_day,
        games_played,
        (SELECT SUM(CASE WHEN game_winner = 1 THEN 1 ELSE 0 END) 
         FROM uniqueGames 
         WHERE game_mode = ''stormLeague'' AND DATE(game_timestamp) = game_date) AS games_won,
        (SELECT SUM(CASE WHEN game_winner = 1 THEN 1 ELSE 0 END) / COUNT(*) 
         FROM uniqueGames 
         WHERE game_mode = ''stormLeague'' AND DATE(game_timestamp) <= game_date) AS aggregate_winrate
     FROM (
         SELECT DATE(game_timestamp) AS game_date, 
                SUM(CASE WHEN game_winner = 1 THEN 1 ELSE 0 END) / COUNT(*) AS winrate_each_day,
                COUNT(*) AS games_played
         FROM uniqueGames 
         WHERE game_mode = ''stormLeague'' AND DATE(game_timestamp) IN (', @dates, ') 
         GROUP BY game_date
     ) AS subquery
     ORDER BY game_date'
);

-- Debug: Print the constructed query (optional)
SELECT @sql;

-- Prepare and execute the dynamic statement
PREPARE stmt FROM @sql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;
